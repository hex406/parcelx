# Amazon Selling Partner API

Workflow of Integrating Amazon Seller Partner API
```
https://developer-docs.amazon.com/sp-api/
```

## Getting Started

### 1) Creating Amazon Selling Account :
Link : [Register](https://sellercentral.amazon.in/signin)

#### We can use personal amazon.in account for registration, Best to create new account for organizations.

### 2) Registering for Amazon Developer Account :
Link : [Register](https://sellercentral.amazon.in/developer/register)

#### Roles required for getting authorised sellers customer's data :
* Direct-to-Consumer Shipping (Restricted)

Other roles may also be selected as per use case. Roles definition and usage can be found here : [https://developer-docs.amazon.com/sp-api/docs/roles-in-the-selling-partner-api]

#### Important policies to read
* [Data Protection Policy](https://sellercentral.amazon.in/mws/static/policy?documentType=DPP&locale=en_IN)
* [API Agreement](https://sellercentral.amazon.in/mws/static/agreement?&locale=en_IN)
* [Acceptable Usage Policy](https://sellercentral.amazon.in/mws/static/agreement?&locale=en_IN)

#### Note :
In other Amazon Marketplaces other than India you have opt for Professional selling plan and pay some fees monthly.

### 3) Register for AWS Account and Creating IAM User, Policy and Roles.
Link : [Register](https://portal.aws.amazon.com/billing/signup)
#### Free tier is also usable.

#### Refer to Amazon Official guide for creation of IAM User, Role and Policy for SP-API :
Link : [Guide](https://developer-docs.amazon.com/sp-api/docs/creating-and-configuring-iam-policies-and-entities)

#### Once the developer account has been approved after amazon review of the application form which we filled out in Step 2, We can proceed to creating application client which will get listed in Amazon Seller Marketplace since we have to develop 'Public Application' so that different users with their seller accounts can authorize their seller account to us so we can get their order data of customers such as 'Customer's Name, Address, Shipping Address'

### 4) Registering Application
* In the Partner Network menu, click Develop Apps. Or Goto [Link Directly](https://sellercentral.amazon.in/sellingpartner/developerconsole/) 
* Click Add new app client and compelete the form.
* Use Amazon AWS IAM user to which the policy is attached to which we created using amazon guide in previous step #4.
#### We can select Seller or Vendor according to the usage, Seller preferred.
* After succesful registration of application, we can view our LWA (Login With Amazon) credentials by clicking "view" under "LWA Credentials" for the application we want.
#### Save LWA Client Identifier and LWA Client Secret as they will be required to request LWA Access Token.

### 5) Setting up "Authorize" Button on our site under channel Integration menu.
#### Workflow of authorize button :
* A) Selling Partner (Customer registered on Parcelx) Visits our site and click on "Authorize" button.
* B) Selling Partner will be redirected to constructed OAuth URL to Login With Amazon Page of Seller Central. Selling Partner if not already logged in, can login with his credentials on redirected amazon login official page.
* C) Selling Partner reviews the data access requested by our application which we created earlier in step 4 and clicks on "Confirm" to continue.
* D) Amazon redirects back to our landing page with necessary authorization information required to call SP-API on sellers behalf to get order data and necessary information.
* E) Once, Authorization completes. We will be able to use SP-API Endpoints to get sellers order data and process the data on our site.

#### Technical Aspects of Authorize button and consent workflow :
* A) Once the selling partner (Customer registered on parcelx) clicks on authorized button constructed by us to redirect to OAuth URL (Check here for more on construction OAuth URI : [Link](https://developer-docs.amazon.com/sp-api/docs/authorizing-selling-partner-api-applications#constructing-an-oauth-authorization-uri)), we sends the following query parameters :


``` Redirect URI (Optional):A URI for redirecting the browser to your application. This must an OAuth Redirect URI that you specified when you registered your application. If you do not include the redirect_uri parameter, the default is the first OAuth Redirect URI that you specified when you registered your application.```


```state (Required):A state value generated by your application. Your application uses this value to maintain state between this request and the response, helping to guard against cross-site request forgery attacks.```

For example (OAuth URI with query params) : 

``` https://sellercentral.amazon.com/apps/authorize/consent?application_id=appidexample&state=stateexample&version=beta ```

* B) Once the user confirms the consent on LWA Page, Amazon redirects to our URL with following query parameters :


```state : Which we had sent in earlier step```


```selling_partner_id : The identifier of the selling partner who is authorizing your application. ```


```spapi_oauth_code :The Login with Amazon (LWA) authorization code that you exchange for an LWA refresh token```


#### Note: An LWA authorization code expires after five minutes. Be sure to exchange it for an LWA refresh token before it expires.

* C) Once we get the spapi_oauth_code and necessary information. We fetch the LWA Refresh token by calling LWA Authorization Server (```https://api.amazon.com/auth/o2/token```) to exchange the LWA Auth code (spapi_oauth_code) for an LWA Refresh token.
##### LWA Refresh tokens are indefinitely long-lived token which is required to get new LWA access token which we will request in next step. LWA Access token is short lived and is required for calling SP-APIs on selling partner's behalf.

We call the authorization server link with following query parameters from our application :


``` grant_type : Must be "authorization_code"```


```code : Which we recieved in previous step (spapi_auth_code)```


```redirect_uri : redirect url of our application which will recieve LWA refresh token```


``` client_id : Part of our application LWA credentials.```


``` client_secret : Part of our application LWA credentials.```


##### client_id and client_secret which we got after registering of our appication in step 4

* D) LWA Auth server returns us with JSON which includes the following elements :


```access_token : A token that authorizes our application to take certain actions on behalf of a selling partner. ```


```token_type : should be bearer```


```expires_in : no. of seconds before access_token becomes invalid```


```refresh_token : Long lived token which is required to request for another access_token```


##### We have to save refresh token in our database or file along with client data to request for access_token in future to call SP-API on behalf of selling partners.

* E) Browser displays landing page.

##### Created and Last Edited on 28/06/2022 by Abhishek